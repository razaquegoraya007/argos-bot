/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{getElementBasedOnSelector,getArrayElementBasedOnSelector,getClosestElementBasedOnSelector,createAcrobatIconElement,createURLForAttachment}from"./util.js";import{createFteTooltip,shouldShowFteTooltip,updateFteToolTipCoolDown,acrobatTouchPointClicked,getAcrobatTouchPointFteEligibility,removeGsuiteFteTooltip}from"../gsuite/fte-utils.js";import state from"./state.js";import{sendAnalytics}from"./util.js";import{processForNativeViewer}from"./native-viewer-touch-point-service.js";const ATTACHMENT_CARD_HYPERLINK_CLASS="acrobat-attachmentcard-hyperlink",ACROBAT_PROCESSED_ATTRIBUTE="acrobat-icon-added",GMAIL_FTE_TOOLTIP_STORAGE_KEY="acrobat-gmail-fte-config",GMAIL_FTE_TOOLTIP_CONTAINER_CLASS="acrobat-fte-tooltip-container",getMessageView=()=>getArrayElementBasedOnSelector(document,"messageView","messageView"),getParentElementForAcrobatIcon=t=>getElementBasedOnSelector(t,"attachmentCardParentElementForAcrobatIcon","messageView"),getAttachmentCardElement=t=>getClosestElementBasedOnSelector(t,"attachmentCardElement","messageView"),createAcrobatTooltip=()=>{const t=document.createElement("div");return t.setAttribute("class","acrobat-attachmentcard-tooltip"),t.innerText=state?.gmailConfig?.acrobatPromptText,t},createAcrobatHyperlinkForAttachmentCard=(t,e)=>{t=createURLForAttachment(t,"GmailAttachmentCard",e);const o=document.createElement("a");o.setAttribute("class",ATTACHMENT_CARD_HYPERLINK_CLASS),o.setAttribute("href",t),o.setAttribute("target","_blank"),o.addEventListener("click",(()=>{sendAnalytics([["DCBrowserExt:Gmail:AttachmentCardPrompt:Clicked",{gsuiteFte:getAcrobatTouchPointFteEligibility(state?.gmailConfig?.enableGmailFteToolTip)}]]),acrobatTouchPointClicked("acrobat-gmail-fte-config"),state.fteToolTip.lastGmailFteShown.type="",state.fteToolTip.touchPointClicked=!0}),{signal:state?.eventControllerSignal});const a=createAcrobatIconElement(),n=createAcrobatTooltip();return o.appendChild(a),o.appendChild(n),o},getMessageViewPDFAttachmentsWithoutAcrobatIcon=()=>{const t=getMessageView();let e=[];if(t&&t.length>0)for(let o=0;o<t.length;o++){const a=t[o],n=getArrayElementBasedOnSelector(a,"pdfAttachmentWithoutAcrobatIcon","messageView");n&&n.length>0&&e.push(...n)}return e},removeFteTooltipFromAttachmentDiv=()=>{removeGsuiteFteTooltip(),state.fteToolTip.lastGmailFteShown.type=""},handleClickOutside=(t,e)=>{const o=document.querySelector(".acrobat-fte-tooltip-container");o&&!o.contains(t.target)&&(removeFteTooltipFromAttachmentDiv(),sendAnalytics(["DCBrowserExt:GmailFTE:MessageView:Dismissed"]),e.removeEventListener("click",handleAcrobatTouchPointClickForFte))},addFteTooltipButtonEventListener=(t,e)=>{t.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",(()=>{removeFteTooltipFromAttachmentDiv(),sendAnalytics(["DCBrowserExt:GmailFTE:MessageView:Clicked"]),document.removeEventListener("click",handleClickOutside),e.removeEventListener("click",handleAcrobatTouchPointClickForFte)}))},handleAcrobatTouchPointClickForFte=()=>{document.getElementsByClassName("acrobat-fte-tooltip-container").length>0&&(removeFteTooltipFromAttachmentDiv(),document.removeEventListener("click",handleClickOutside))},addFteTooltipToAttachmentDiv=t=>{const e=createFteTooltip(state?.gmailConfig?.gmailFteToolTipStrings,"messageView");addFteTooltipButtonEventListener(e,t),document.addEventListener("click",(e=>handleClickOutside(e,t)),{once:!0}),t.addEventListener("click",(()=>handleAcrobatTouchPointClickForFte()),{once:!0}),t.appendChild(e),sendAnalytics(["DCBrowserExt:GmailFTE:MessageView:Shown"]),updateFteToolTipCoolDown(state?.gmailConfig?.gmailFteToolTipConfig?.tooltip,"acrobat-gmail-fte-config")},showFteOnAttachmentCardHoverIn=(t,e)=>{t.addEventListener("mouseenter",(()=>{const o=state?.gmailConfig?.gmailFteToolTipConfig?.tooltip;shouldShowFteTooltip(o,state?.fteToolTip,"acrobat-gmail-fte-config").then((o=>{o&&(t.style.zIndex="2",addFteTooltipToAttachmentDiv(e))}))}))},hideFteTooltipOnAttachmentCardHoverOut=t=>{t.addEventListener("mouseleave",(()=>{document.getElementsByClassName("acrobat-fte-tooltip-container").length>0&&(t.style.removeProperty("z-index"),removeFteTooltipFromAttachmentDiv(),"messageView"!==state?.fteToolTip?.attachmentCardClicked&&sendAnalytics(["DCBrowserExt:GmailFTE:MessageView:Ignored"])),document.removeEventListener("click",handleClickOutside)}))},handleAttachmentCardClick=t=>{t.addEventListener("click",(()=>{state.fteToolTip.attachmentCardClicked="messageView",setTimeout((()=>{state.fteToolTip.attachmentCardClicked=""}),1e3)}))},handleFteTooltipForAttachmentCard=(t,e)=>{showFteOnAttachmentCardHoverIn(t,e),hideFteTooltipOnAttachmentCardHoverOut(t),handleAttachmentCardClick(t)},addAcrobatIconToAttachmentCard=t=>{t?.forEach((t=>{const e=t?.closest("a"),o=e?.getAttribute("href");if(o&&o.includes("drive.google.com"))t.setAttribute("acrobat-icon-added","Y");else{const a=getAttachmentCardElement(t),n=getParentElementForAcrobatIcon(a);if(o&&n){const i=getElementBasedOnSelector(e,"attachmentName","messageView")?.textContent,r=createAcrobatHyperlinkForAttachmentCard(o,i);handleFteTooltipForAttachmentCard(a,r),n.appendChild(r),t.setAttribute("acrobat-icon-added","Y"),e?.addEventListener("click",(()=>{sendAnalytics([["DCBrowserExt:Gmail:AttachmentCard:Clicked"]]),setTimeout((()=>processForNativeViewer({url:o})),500),setTimeout((()=>processForNativeViewer({url:o})),1e3)}),{signal:state?.eventControllerSignal})}}}))},addAcrobatTouchPointInTheMessageView=()=>{try{const t=getMessageViewPDFAttachmentsWithoutAcrobatIcon();t&&t.length>0&&addAcrobatIconToAttachmentCard(t)}catch(t){sendAnalytics([["DCBrowserExt:Gmail:MessageView:ProcessingFailed"]])}},removeAllTouchPoints=()=>{const t=document.querySelectorAll(`.${ATTACHMENT_CARD_HYPERLINK_CLASS}`);if(t&&t.length>0)for(let e=0;e<t.length;e++)t[e]?.parentElement?.removeChild(t[e])};export{addAcrobatTouchPointInTheMessageView,removeAllTouchPoints};